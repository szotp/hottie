import 'dart:io';
import 'dart:isolate';

import 'package:hottie/src/script_change.dart';
import 'package:hottie/src/utils/logger.dart';

const _path = 'build/main_hottie.g.dart';

bool _isTestFile(FileSystemEntity file) {
  if (!file.path.endsWith('_test.dart')) {
    return false;
  }

  final segments = file.uri.pathSegments;

  if (!segments.contains('test')) {
    return false;
  }

  if (segments.any((x) => x.startsWith('.'))) {
    return false;
  }

  return true;
}

Files findTestsInCurrentDirectory() {
  final files = Directory.current.listSync(recursive: true).where(_isTestFile).toList();

  if (files.isEmpty) {
    logger.warning('No test files found in ${Directory.current}');
  }

  print(files.length);

  return Files(files.map((x) => x.uri).toSet());
}

Future<Uri> generateMain(Files testPaths) async {
  final resolved = await Isolate.resolvePackageUri(Uri.parse('package:hottie/hottie_insider.dart'));

  final buffer = StringBuffer();
  buffer.writeln('// GENERATED BY hottie');
  if (testPaths.uris.isNotEmpty) {
    buffer.writeln("import 'package:flutter_test/flutter_test.dart';");
  }
  buffer.writeln("import '$resolved';");

  for (final (index, uri) in testPaths.uris.indexed) {
    buffer.writeln("import '$uri' as f$index;");
  }

  buffer.writeln('TestMap _tests() => {');

  for (final (index, Uri path) in testPaths.uris.indexed) {
    buffer.writeln("'$path': f$index.main,");
  }

  buffer.writeln('};');
  buffer.writeln('Future<void> main() => hottie(_tests);');

  buffer.writeln("@pragma('vm:entry-point')");
  buffer.writeln('Future<void> hottieIsolated() => runTests(_tests);');

  if (!Directory('build').existsSync()) {
    Directory('build').createSync();
  }
  File(_path).writeAsStringSync(buffer.toString());
  return Uri.file(_path);
}
